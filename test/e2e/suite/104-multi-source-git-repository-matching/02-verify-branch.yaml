apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
- script: |
    echo "=== Running Image Updater to Test Branch Selection ==="

    # Run image updater with trace logging
    ${SRC_DIR}/dist/argocd-image-updater run --once \
      --argocd-namespace argocd \
      --match-application-name write-helmvalues \
      --loglevel trace 2>&1 | tee /tmp/updater.log

    echo "\n=== Verifying Application Configuration ==="

    # Check if values source is correctly configured to use 'main' branch
    VALUES_BRANCH=$(kubectl get application write-helmvalues -n argocd -o jsonpath='{.spec.sources[?(@.ref=="values")].targetRevision}')
    if [ "$VALUES_BRANCH" != "main" ]; then
      echo "Error: Values source is using incorrect branch: $VALUES_BRANCH (expected: main)"
      exit 1
    fi

    # Check if write-back target is correctly configured
    WRITE_TARGET=$(kubectl get application write-helmvalues -n argocd -o jsonpath='{.metadata.annotations.argocd-image-updater\.argoproj\.io/write-back-target}')
    if [[ ! "$WRITE_TARGET" =~ ^helmvalues:(/|//).*/values\.yaml$ ]]; then
      echo "Error: Write-back target is incorrectly configured: $WRITE_TARGET"
      exit 1
    fi

    # Verify git repository configuration
    GIT_REPO=$(kubectl get application write-helmvalues -n argocd -o jsonpath='{.metadata.annotations.argocd-image-updater\.argoproj\.io/git-repository}')
    if [ -z "$GIT_REPO" ]; then
      echo "Error: Git repository not configured in annotations"
      exit 1
    fi

    echo "Success: Application configuration verified - using correct branch and write-back settings"
